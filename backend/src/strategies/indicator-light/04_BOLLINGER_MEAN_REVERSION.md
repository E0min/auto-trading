# 볼린저밴드 역추세 전략 (Bollinger Band Mean Reversion)

> 원본: 교수 (BB + RSI 조합), 한소희 (스토캐스틱 + BB), 도장의 꿈 (지표 없이 가격 핸들링)
> 대상: Bitget USDT-FUTURES (알트코인 위주)
> 포지션: 양방향 (Long & Short)
> 타임프레임: 5분봉 기준

---

## 1. 진입 신호 (Entry Signal)

### 핵심 원리
가격이 볼린저밴드 상/하단을 이탈한 후 **밴드 안쪽으로 회귀하는 성질**을 이용한다. 과매수/과매도 구간에서 반대 방향으로 진입하며, RSI와 스토캐스틱으로 확인 신호를 받는다.

### 볼린저밴드 계산
```
중심선 (Middle Band) = SMA(종가, 20)
상단밴드 (Upper Band) = 중심선 + (2 × 표준편차(종가, 20))
하단밴드 (Lower Band) = 중심선 - (2 × 표준편차(종가, 20))
밴드폭 (Bandwidth) = (상단 - 하단) / 중심선 × 100
%B = (종가 - 하단) / (상단 - 하단)
```

### RSI 설정
```
RSI 기간 = 14
과매수 기준 = 70
과매도 기준 = 30
```

### 스토캐스틱 설정
```
%K 기간 = 14
%D 기간 = 3 (SMA of %K)
과매수 = 80
과매도 = 20
```

### 롱 진입 조건

| # | 조건 | 상세 |
|---|------|------|
| 1 | **BB 하단 이탈 후 재진입** | 이전 봉 종가 < 하단밴드 AND 현재 봉 종가 > 하단밴드 |
| 2 | **RSI 과매도 반등** | RSI(14) 가 30 이하에서 30 이상으로 상향 돌파 |
| 3 | **스토캐스틱 확인** | %K가 %D를 상향 돌파 (20 이하 구간에서) |
| 4 | **MarketRegime 확인** | `RANGING` 또는 `VOLATILE` (추세장에서 역추세 금지) |
| 5 | **밴드폭 확인** | Bandwidth > 2% (밴드가 충분히 열려있어야 수익 공간 존재) |

### 숏 진입 조건

| # | 조건 | 상세 |
|---|------|------|
| 1 | **BB 상단 이탈 후 재진입** | 이전 봉 종가 > 상단밴드 AND 현재 봉 종가 < 상단밴드 |
| 2 | **RSI 과매수 반전** | RSI(14) 가 70 이상에서 70 이하로 하향 돌파 |
| 3 | **스토캐스틱 확인** | %K가 %D를 하향 돌파 (80 이상 구간에서) |
| 4 | **MarketRegime 확인** | `RANGING` 또는 `VOLATILE` |
| 5 | **밴드폭 확인** | Bandwidth > 2% |

### 필터 (비진입 조건)
- MarketRegime이 `TRENDING_UP`일 때 숏 진입 금지
- MarketRegime이 `TRENDING_DOWN`일 때 롱 진입 금지
- BB Bandwidth < 1.5% → 밴드 스퀴즈 구간으로 진입 보류 (돌파 가능성 높음)

---

## 2. 매수 조건 (Buy Conditions)

### 롱 진입 (OPEN_LONG)

```
IF  prev_close < bb_lower                    // 이전 봉 하단 이탈
AND curr_close > bb_lower                     // 현재 봉 밴드 안으로 복귀
AND rsi_14 > 30                               // RSI 과매도 탈출
AND rsi_14_prev <= 30                         // 이전 봉 RSI 과매도였음
AND stoch_k > stoch_d                         // 스토캐스틱 골든크로스
AND stoch_k_prev <= stoch_d_prev              // 이전 봉에서는 아래
AND bb_bandwidth > 2.0                        // 밴드폭 충분
AND market_regime IN ('ranging', 'volatile')  // 횡보/변동장
THEN → OPEN_LONG
```

### 숏 진입 (OPEN_SHORT)

```
IF  prev_close > bb_upper                     // 이전 봉 상단 이탈
AND curr_close < bb_upper                     // 현재 봉 밴드 안으로 복귀
AND rsi_14 < 70                               // RSI 과매수 탈출
AND rsi_14_prev >= 70                         // 이전 봉 RSI 과매수였음
AND stoch_k < stoch_d                         // 스토캐스틱 데드크로스
AND stoch_k_prev >= stoch_d_prev              // 이전 봉에서는 위
AND bb_bandwidth > 2.0                        // 밴드폭 충분
AND market_regime IN ('ranging', 'volatile')  // 횡보/변동장
THEN → OPEN_SHORT
```

### 진입 방식
- 시장가(MARKET) 즉시 진입
- 진입과 동시에 TP/SL 자동 세팅
- 분할 매수 허용: 최대 3회 (1차 40%, 2차 30%, 3차 30%)

### 분할 매수 조건
```
1차 진입: 위 조건 충족 시 (40% 비중)
2차 진입: 1차 진입가 대비 -3% AND RSI < 25 (30% 비중)
3차 진입: 2차 진입가 대비 -3% AND RSI < 20 (30% 비중, 최종)
3차 진입 후 손절선: 3차 진입가 대비 -4%
```

> "물타기는 총 맥스 3회, 비중은 1:1:2 까지만 들어가고, 3진입후 손절"

---

## 3. 매도 조건 (Sell Conditions)

### 롱 포지션 청산 (CLOSE_LONG)

| 우선순위 | 조건 | 설명 |
|----------|------|------|
| 1 | **BB 중심선 도달** | 가격이 BB 중심선(SMA 20) 도달 시 **반익절(50%)** |
| 2 | **BB 상단 도달** | 가격이 BB 상단밴드 도달 시 **나머지 전량 익절** |
| 3 | **RSI 70 도달** | RSI가 70 이상 시 전량 익절 |
| 4 | **손절** | 평균 진입가 대비 -4% 시 전량 손절 |
| 5 | **시간 손절** | 진입 후 1시간 경과 시 ±0 근처에서 정리 |

### 숏 포지션 청산 (CLOSE_SHORT)

| 우선순위 | 조건 | 설명 |
|----------|------|------|
| 1 | **BB 중심선 도달** | 가격이 BB 중심선 도달 시 **반익절(50%)** |
| 2 | **BB 하단 도달** | 가격이 BB 하단밴드 도달 시 **나머지 전량 익절** |
| 3 | **RSI 30 도달** | RSI가 30 이하 시 전량 익절 |
| 4 | **손절** | 평균 진입가 대비 +4% 시 전량 손절 |
| 5 | **시간 손절** | 진입 후 1시간 경과 시 ±0 근처에서 정리 |

### 반익절 전략
> "초반에 반익절하고 봇중단까지 들고 가도록 했어요"

- BB 중심선 도달 시 포지션의 50% 익절
- 나머지 50%는 BB 반대쪽 밴드까지 홀딩 (또는 추세 전환 시 청산)

---

## 4. 리스크 관리 (Risk Management)

### 포지션 관리

| 항목 | 값 | 근거 |
|------|-----|------|
| 레버리지 | 3x | 역추세 전략은 보수적 레버리지 필수 |
| 최대 포지션 비중 | 자산의 5% | 분할 매수 포함 총합 |
| 분할 매수 | 최대 3회 | 1차 40%, 2차 30%, 3차 30% |
| 최종 손절 | 평균 진입가 -4% | 3차 진입 후 추가 하락 시 |
| TP:SL 비율 | 약 1.5:1 ~ 2:1 | 중심선까지 약 6~8%, SL 4% |
| 동시 포지션 | 최대 3심볼 | 총 노출 15% 이내 |

### 추세장 보호

> "추세추종 확률도 은근히 있고 손익비도 좋은" — 역추세는 추세장에서 위험

| MarketRegime | 롱 | 숏 | 비고 |
|-------------|-----|-----|------|
| TRENDING_UP | 허용 | **금지** | 상승 추세에서 숏 역추세 금지 |
| TRENDING_DOWN | **금지** | 허용 | 하락 추세에서 롱 역추세 금지 |
| RANGING | 허용 | 허용 | 역추세 전략 최적 환경 |
| VOLATILE | 허용 | 허용 | 분할 매수 비중 축소 (60/40 → 2회만) |
| QUIET | 보류 | 보류 | 밴드폭 좁아 수익 공간 부족 |

### 주말 특수 설정
> "주말은 알트들 변동성이 좋나봐요. 역추세 전략에 주말이 유리"

- 주말(토/일): 포지션 비중 20% 증가 허용 (자산의 6%)
- 평일 대비 적극적 운용

### RiskEngine 연동
```
validateOrder 통과 필수:
  1. CircuitBreaker — 연속 5회 손절 시 30분 쿨다운
  2. DrawdownMonitor — 일일 손실 3%, 총 MDD 10% 초과 시 중단
  3. ExposureGuard — 총 노출 30% 초과 시 신규 진입 거부
```

### ReduceOnly
- 모든 청산/익절 주문에 `reduceOnly: true` 필수
- 분할 익절 시에도 `reduceOnly: true` 적용

### MDD 한도
- 전략별 MDD 한도: **-10%**
- 분할 매수 포함 총 손실이 10% 도달 시 전략 비활성화
- 이전 MDD 경험: "폭락 시 -40% MDD 경험, 안정장치 추가 후 -15%로 개선" (도장의 꿈)

---

## 구현 매핑 (StrategyBase 연동)

```javascript
// onKline(kline) → BB(20,2), RSI(14), Stochastic(14,3) 계산
// onTick(ticker) → TP/SL 체크, 반익절 트리거
// getSignal() → { action, symbol, confidence, suggestedQty }
// setMarketRegime() → 추세장 방향별 진입 필터
```

### 필요 외부 라이브러리
- `talib` 또는 `technicalindicators` — BB, RSI, Stochastic 계산
- BB %B 및 Bandwidth는 자체 수식으로 계산 가능
