# Round 11 Cross-Review — Senior Quant Trader

> 작성일: 2026-02-17
> 역할: Senior Quant Trader (매매 전략, 리스크 관리, 포지션 사이징, 백테스트 품질)
> 대상: Engineer 제안서 15건 + UI/UX 제안서 13건

---

## Engineer 제안서 리뷰

### E11-1. BotSession 상태 불일치 — peakEquity 복원 실패

**판정: ✅ 동의 (P0 즉시)**

직접 코드를 확인했다. `stop()`에서 `BOT_STATES.IDLE`('idle')로 저장하고, `start()`에서 `{ status: 'stopped' }`로 조회한다. 매칭이 되지 않으므로 peakEquity가 절대 복원되지 않는다.

이 버그의 트레이딩 영향은 심각하다. DrawdownMonitor가 매 세션 시작 시 peakEquity=0에서 출발하므로, 이전 세션에서 자본 고점이 $12,000이었는데 현재 $10,500으로 시작하더라도 drawdown이 0%로 계산된다. 실질적으로 **drawdown halt가 세션 간 연속성을 잃어**, 누적 손실이 10%를 초과해도 보호 메커니즘이 작동하지 않는 구간이 존재한다.

**보완 의견**: `findOne`의 쿼리를 `{ status: { $in: ['idle', 'stopped'] } }`로 변경하는 것이 더 안전하다. 향후 상태 값이 변경되더라도 하위 호환성을 유지한다.

---

### E11-2. SignalFilter close 시그널 바이패스 오류

**판정: ✅ 동의 (P0 즉시)**

직접 확인 완료. `SIGNAL_ACTIONS`에는 `'close_long'`, `'close_short'`만 정의되어 있고, `'CLOSE'`라는 값은 존재하지 않는다. `signal.reduceOnly`가 true인 경우만 바이패스를 타므로, 일반 전략에서 emit하는 `close_long`/`close_short` 시그널이 쿨다운/중복 필터에 걸릴 수 있다.

**트레이딩 영향**: 이것은 실거래에서 **청산 지연 또는 누락**을 일으킬 수 있는 위험한 버그다. 특히:
- 트렌드 반전 시 SupportResistance나 SwingStructure가 보내는 close 시그널이 쿨다운에 의해 차단되면, 포지션이 손실 구간에 노출되는 시간이 길어진다.
- 여러 전략이 동시에 같은 심볼에 close를 보낼 때 중복 필터에 걸리면 첫 번째 전략의 close만 통과하고 나머지는 무시될 수 있다.

Engineer 제안 수정안(`SIGNAL_ACTIONS.CLOSE_LONG || SIGNAL_ACTIONS.CLOSE_SHORT || signal.reduceOnly`)이 정확하다.

---

### E11-3. Trailing Stop 인프라 미사용

**판정: ⚠️ 조건부 동의**

grep 결과 확인 완료 — 18개 전략 중 `_checkTrailingStop()`을 호출하는 곳이 0건이다. R10에서 구현한 인프라가 완전히 dead code 상태이다.

**보완 조건**:

1. **Option 1(기본 클래스 자동 호출)은 반대한다.** Trailing stop은 모든 전략에 적합하지 않다. Grid 전략처럼 좁은 범위에서 반복 매매하는 전략에 trailing stop을 적용하면, 정상적인 그리드 포지션이 조기 청산되어 수익 구조가 깨진다. Bollinger, RSIPivot 같은 평균 회귀 전략도 마찬가지로, trailing stop이 과도한 조기 이탈을 유발한다.

2. **추천 적용 대상 (opt-in)**:
   - **Turtle** — 트렌드 추종의 대표 전략. ATR 기반 trailing stop과 자연적 시너지.
   - **MaTrend** — 이동평균 크로스 기반. 트렌드가 길어질 때 수익 보호에 효과적.
   - **SwingStructure** — 스윙 고점/저점 추적. 구조적으로 trailing stop과 궁합이 맞음.
   - **Supertrend** — 지표 자체가 trailing 성격. 보조적으로 추가하면 이중 보호.
   - **Breakout** — 브레이크아웃 후 추세가 지속될 때 수익 극대화.
   - **AdaptiveRegime** — 트렌드 레짐에서만 활성화되는 전략이므로 trailing stop이 유효.

3. **적용하지 말아야 할 전략**:
   - **Grid** — 그리드 간격 내에서 매매하므로 trailing stop이 구조를 파괴
   - **Funding** — 펀딩비 기반. 가격 변동이 아닌 펀딩비 수렴에 의존
   - **RSIPivot** — 과매도 반등 노림. Trailing이 반등 초기 구간에서 이탈 유발
   - **Bollinger** — 밴드 회귀 전략. Trailing이 밴드 중심으로의 복귀를 방해
   - **Vwap** — 장중 평균 회귀. 단기 전략에 trailing stop은 과잉 메커니즘
   - **QuietRangeScalp** — 소규모 스캘핑에 trailing stop 불필요

4. **구현 방식**: 전략의 `static metadata`에 `trailingStopEnabled: true/false` 필드를 추가하고, `strategyBase.onTick()`에서 메타데이터를 확인하여 조건부 호출하는 것이 가장 깔끔하다. 이렇게 하면 개별 전략 파일을 수정하지 않고도 메타데이터 선언만으로 제어 가능하다.

---

### E11-4. 테스트 커버리지 전무

**판정: ✅ 동의 (P2)**

우선 테스트 대상 순서에 대해 한 가지 보완한다.

**트레이딩 관점 우선순위 조정**:
1. **riskEngine + 서브엔진 3개** — 동의. 주문 거부/승인 판정의 정확성은 자본 보전의 핵심.
2. **signalFilter** — 동의. E11-2 같은 버그 재발 방지에 필수.
3. **backtestEngine** — Engineer가 5순위로 놓았지만, **3순위로 격상을 제안한다.** PnL 계산이 부정확하면 백테스트 결과 자체가 무의미해지고, 이를 기반으로 한 전략 선택/파라미터 튜닝이 모두 오염된다. 슬리피지/수수료 적용, 부분 체결 시뮬레이션, 에쿼티 추적이 실거래와 정합한지 검증이 필요하다.
4. **drawdownMonitor** — 동의.
5. **orderManager** — 동의.

테스트 작성 시 주의: 리스크 엔진 테스트에서는 **경계값(boundary)** 케이스를 반드시 포함할 것. `maxDrawdownPercent`가 정확히 10.00%인 경우, `consecutiveLossLimit`이 정확히 한도와 같은 경우 등. 이런 경계에서 `>=` vs `>` 한 글자 차이로 트레이딩 행동이 바뀐다.

---

### E11-5. Signal 모델 인덱스 부재

**판정: ✅ 동의**

Signal 컬렉션은 봇 가동 중 매 시그널마다 write되고, 대시보드에서 지속적으로 read된다. 인덱스 없이 풀 스캔은 수천 건 누적 시 응답 지연을 유발한다. 제안된 3개 복합 인덱스가 적절하다.

---

### E11-6. Trade 모델 TTL 부재

**판정: ⚠️ 조건부 동의**

**보완 조건**: 180일 TTL은 너무 짧을 수 있다. 전략 성과 분석에서 장기 데이터(6개월~1년)가 필요한 경우가 많다. 예를 들어 특정 레짐(VOLATILE)에서의 전략 성과를 계절성 관점에서 분석하려면 최소 1년 데이터가 필요하다.

**대안 제안**:
- TTL 365일 (1년)로 설정하거나,
- TTL 대신 아카이브 컬렉션 + cron 방식 (180일 이상 된 레코드를 `trades_archive`로 이동)
- 아카이브된 데이터도 분석 API를 통해 접근 가능하도록 구성

실거래 이력은 리스크 감사(audit) 관점에서도 보존 가치가 높으므로 단순 삭제보다 아카이브를 권장한다.

---

### E11-7. PaperEngine 미결 주문 무제한 축적

**판정: ✅ 동의**

**추가 의견**: 30분 TTL은 적절하다. 실제 Bitget 거래소의 limit order도 GTC(Good-Til-Cancelled)가 기본이지만, 페이퍼 엔진에서는 시뮬레이션 속도 관점에서 30분이면 충분하다. 다만, 자동 만료 시 `orderCancelled` 이벤트를 emit하여 로그에 기록해야 한다. 그래야 "왜 이 주문이 사라졌는지" 추적이 가능하다.

최대 50건 제한도 합리적이다. 18개 전략이 각각 최대 2~3개 심볼에 리밋 주문을 걸더라도 50건이면 여유가 있다.

---

### E11-8. WebSocket 재연결 후 재구독 누락

**판정: ✅ 동의 (P1)**

트레이딩 시스템에서 시세 피드 중단은 사일런트 장애 중 가장 위험한 유형이다. 에러 로그도 없이 단순히 데이터가 오지 않는 상태가 되면, 봇은 마지막 틱 데이터 기준으로 판단을 내리게 된다. 이는 stale price로 잘못된 시그널을 생성하거나, 포지션 관리에서 SL/TP 트리거를 놓치는 결과를 초래한다.

**추가 제안**: 재구독 로직과 별개로, "마지막 틱 수신 시각"을 추적하고 일정 시간(예: 30초) 이상 틱이 없으면 `MARKET_EVENTS.FEED_STALE` 이벤트를 emit하는 방어 로직도 고려할 것.

---

### E11-9. 일일 리셋 타이밍 취약점

**판정: ✅ 동의**

**Engineer의 질문에 대한 답변**: 일일 리셋 시점은 **UTC 00:00 유지**를 권장한다.
- 암호화폐는 24시간 글로벌 시장이므로 KST 기준이 특별히 유리하지 않다.
- Bitget 거래소의 펀딩비 정산(00:00, 08:00, 16:00 UTC)과 일관성을 유지하는 것이 분석에 유리하다.
- 대부분의 글로벌 트레이딩 시스템이 UTC 자정을 일일 경계로 사용한다.

날짜 변경 감지 방식(`todayDate !== _lastResetDate`)으로의 전환에 동의한다. 이렇게 하면 봇이 어느 시간에 재시작되더라도 당일 리셋이 보장된다.

---

### E11-10. API 라우트 입력 검증 부재

**판정: ✅ 동의**

특히 `leverage` 범위 검증이 중요하다. leverage: 125 같은 값이 그대로 주문에 적용되면 1% 역방향 움직임에도 전체 포지션이 청산될 수 있다. `maxPositionPercent`의 문자열 범위 검증도 필수이다 — `"200"`이 들어오면 자본의 200%를 한 포지션에 투입하게 된다.

Zod 기반이 TypeScript 프론트엔드와의 일관성 면에서 좋고, 에러 메시지가 자동 생성되는 장점이 있다.

---

### E11-11. 환경변수 시작 시 검증 없음

**판정: ✅ 동의**

제안된 코드가 간결하고 적절하다. 라이브 모드에서 API 키 없이 시작하면 런타임 중 불명확한 에러가 발생할 것이므로, fast-fail이 올바른 접근이다.

---

### E11-12. Bootstrap 중간 실패 시 복구 경로 없음

**판정: ✅ 동의 (P2)**

실제 운영에서 MongoDB가 느리게 응답하거나 WS 초기 연결이 타임아웃되는 경우가 있다. 이 때 이미 연결된 WS가 cleanup 없이 orphan 상태로 남으면, 다음 프로세스 재시작 시 자원 충돌이 발생할 수 있다. graceful shutdown 패턴의 연장선이다.

---

### E11-13. mathUtils parseFloat 정밀도 한계

**판정: ⚠️ 조건부 동의**

**현실적 영향 평가**: 현재 시스템이 다루는 금액 범위(BTC ~$100,000, 포지션 크기 ~$50,000, 수량 ~1 BTC)에서 IEEE 754 배정밀도의 유효숫자 15~17자리는 충분하다. `0.00000001` 단위의 정밀도도 보존된다.

**보완 조건**: 즉시 `big.js`로 마이그레이션하기보다, 다음 순서를 제안한다:
1. **현재**: mathUtils의 모든 함수에 `toFixed(precision)` 적용을 확인하여 출력값의 일관성 보장 (이미 `DEFAULT_PRECISION = 8`이 있으므로 대부분 커버)
2. **향후**: 다중 거래소 지원이나 대규모 자본 운용($1M+) 시점에 `big.js` 전환
3. **테스트**: E11-4에서 mathUtils 테스트에 극단값(16자리 이상) 케이스를 추가하여 현재 한계를 문서화

급한 마이그레이션은 불필요하지만, 코드베이스에 "향후 전환 포인트" 주석을 남겨두는 것이 좋다.

---

### E11-14. MongoDB 커넥션 풀 모니터링

**판정: ✅ 동의 (P2)**

운영 관측성 관점에서 유용하다. 트레이딩 시스템에서 DB 타임아웃이 발생하면 주문 기록 누락이나 세션 상태 불일치가 생길 수 있으므로, 풀 사용률을 사전에 모니터링하는 것은 합리적이다.

---

### E11-15. 리스크 이벤트 Prometheus 메트릭

**판정: ✅ 동의 (P2)**

리스크 이벤트 카운터는 시스템 건전성의 핵심 지표다. `risk_order_rejected_total`이 급증하면 전략이 시장 환경에 맞지 않는 시그널을 과다 생성하고 있다는 신호이고, `risk_drawdown_halt_total`이 증가하면 자본 관리 파라미터를 재검토해야 한다는 신호이다. 운영 대시보드(Grafana 등)와 연동하면 실시간 건전성 모니터링이 가능해진다.

---

## UI/UX 제안서 리뷰

### R11-FE-01. MarketRegimeIndicator.tsx 삭제

**판정: ✅ 동의**

Import 0건이 확인되었으므로 안전한 삭제이다. dead code 제거는 코드 탐색 시 혼란을 줄인다.

---

### R11-FE-02. risk.ts의 `any` 타입 제거

**판정: ✅ 동의**

**UI/UX 에이전트의 질문에 대한 답변**: 백엔드 `riskEngine.getStatus()` 응답에는 각 서브엔진의 전체 상태가 포함된다. 구체적으로:
- `drawdownMonitor.params.maxDrawdownPercent` — 포함됨 (DrawdownMonitor의 config)
- `drawdownMonitor.drawdownPercent` — `currentDrawdownPercent`로 포함됨 (필드명 확인 필요)
- `circuitBreaker.consecutiveLosses` — 포함됨
- `circuitBreaker.consecutiveLossLimit` — `params.consecutiveLossLimit`으로 포함됨

`RiskStatus` 타입 확장이 올바른 접근이다. 다만 백엔드의 실제 응답 필드명과 정확히 일치시키려면 `GET /api/risk/status` 핸들러의 직렬화 코드를 확인해야 한다.

---

### R11-FE-03. `as unknown as` 캐스트 제거

**판정: ✅ 동의**

제네릭 컴포넌트로의 전환이 타입 안전성을 높이면서 사용부 코드도 깔끔해진다. 트레이딩 영향 없음.

---

### R11-FE-04. `as never` 캐스트 공통화

**판정: ✅ 동의**

Recharts Tooltip 타입 문제는 라이브러리 한계이므로, 한 곳에서 해결하고 재사용하는 것이 올바르다. 차트 포맷터의 일관성은 대시보드의 신뢰성에 기여한다 — 트레이더가 PnL 수치를 볼 때 포맷이 일관되어야 혼동이 없다.

---

### R11-FE-05. PaperModeGate 공통 컴포넌트

**판정: ✅ 동의**

중복 제거. 트레이딩 영향 없음.

---

### R11-FE-06. CATEGORY_LABEL 통일

**판정: ✅ 동의**

3곳에서 같은 카테고리에 다른 표현을 쓰는 것은 UX 일관성 문제이다. 통일된 한국어 표현으로 고정하면 전략 카테고리 비교 시 혼동을 줄인다. "경량지표"와 "지표 경량"이 같은 것인지 다른 것인지 사용자가 판단할 필요가 없어야 한다.

---

### R11-FE-07. formatPnl 유틸 승격

**판정: ✅ 동의**

PnL 포맷팅은 전체 시스템에서 일관되어야 한다. 부호 포함 포맷(`+12.34` / `-5.67`)은 손익을 직관적으로 보여주는 표준 형식이다.

---

### R11-FE-08. tournament/page.tsx 분할

**판정: ✅ 동의 (P2)**

478줄 단일 파일은 유지보수성 관점에서 분할이 합리적이다. 다만, 이 작업은 기능 변경 없이 구조만 바꾸는 것이므로 다른 기능 개선보다 후순위가 적절하다.

---

### R11-FE-09. 백테스트 결과 비교 기능

**판정: ⚠️ 조건부 동의**

**트레이딩 관점에서 매우 가치 있는 기능이다.** 전략 간 성과 비교는 퀀트 트레이더의 핵심 워크플로우이며, 현재 하나씩만 볼 수 있는 것은 심각한 UX 제약이다.

**보완 조건**:

1. **비교 지표 우선순위**: 제안된 7개 지표 중, 트레이딩 관점에서의 중요도 순서를 제안한다:
   - **최대 낙폭(MDD)** — 리스크 대비 수익률 판단의 핵심. 가장 눈에 띄게 표시할 것.
   - **샤프 비율** — 리스크 조정 수익률의 표준 지표
   - **수익 팩터(Profit Factor)** — 1 미만이면 전략이 순손실
   - **총 수익률** — 절대 성과
   - **승률** — 참고용 (높은 승률 + 낮은 수익 팩터는 나쁜 전략)
   - **소르티노/칼마** — 보조 지표

2. **에쿼티 커브 오버레이는 필수다.** 두 전략의 자본 곡선을 같은 차트에 겹치면, "어느 구간에서 어느 전략이 우위인가"를 시각적으로 즉시 파악 가능하다. 이것이 없으면 비교 기능의 가치가 절반으로 줄어든다.

3. **향후 확장**: 2건 비교에서 시작하되, 3건 이상 비교 확장은 나중에 고려해도 된다. 2건 비교만으로도 A/B 테스트 워크플로우의 80%를 커버한다.

---

### R11-FE-10. 백테스트 폼 유효성 검증 강화

**판정: ✅ 동의**

**트레이딩 관점 추가 의견**:
- 심볼 형식 검증(`XXXUSDT`)은 좋지만, 가능하다면 백엔드에서 지원 심볼 목록을 가져와 드롭다운으로 제공하는 것이 더 낫다. 수동 입력 시 `BTCUSDT`와 `btcusdt`의 대소문자 불일치 등 오류 가능성이 있다.
- 수수료 합리적 범위는 0~1%를 제안한다(5%는 너무 관대). Bitget의 실제 taker fee는 0.06%이므로, 0.5% 이상 입력 시 경고, 1% 이상 입력 시 에러가 적절하다.
- 슬리피지도 0~0.5% 범위가 합리적이다. 1% 이상의 슬리피지는 극단적 시장 상황에서만 발생하므로 경고를 표시하되 입력은 허용하는 것이 좋다.
- **초기 자본 최소값**은 $100 이상을 제안한다. 그 이하에서는 수수료 비율이 과도해져 백테스트 결과가 비현실적이다.

---

### R11-FE-11. useStrategyDetail 적응형 폴링 전환

**판정: ✅ 동의**

탭 비활성 시 불필요한 API 호출 제거는 합리적이다. 트레이딩 영향 없음.

---

### R11-FE-12. PerformanceTabs lazy loading

**판정: ✅ 동의**

마운트 즉시 4개 API를 호출하는 것은 낭비이다. 특히 에쿼티 커브만 보는 빈도가 높다면, 나머지 3개 API의 지연 로딩은 초기 로드 속도와 서버 부하 모두에 이득이다.

---

### R11-FE-13. 커스텀 다이얼로그 접근성

**판정: ✅ 동의**

접근성은 기본 품질이다. 트레이딩 영향은 없지만, Escape 키 닫기는 빠른 조작이 필요한 트레이딩 UI에서 실용적이기도 하다.

---

## Engineer에게 응답하는 항목

### E11-1 (peakEquity 복원) 관련
- `maxDrawdownPercent: 10%`는 **누적 기준**으로 의도된 파라미터이다. 세션 간 리셋은 의도된 동작이 아니므로, peakEquity 복원이 반드시 작동해야 한다.
- 다만, 매우 오래된 세션(예: 3개월 전)의 peakEquity를 복원하면 현재 자본 대비 과도한 drawdown이 계산될 수 있다. `lastSession` 쿼리에 `stoppedAt: { $gte: 7일 전 }` 같은 시간 제한을 두는 것도 고려할 것.

### E11-3 (Trailing Stop) 관련
- 위 E11-3 리뷰에서 상세 답변 완료. 요약: **opt-in 방식**, 트렌드 추종 전략 6개에만 적용, metadata 기반 제어 권장.

### E11-9 (일일 리셋) 관련
- **UTC 00:00 유지** 권장. 이유는 E11-9 리뷰에 서술.

---

## 종합 의견

### 핵심 요약

두 제안서 모두 코드베이스를 정밀하게 분석한 결과이며, 발견 사항의 질이 높다.

**즉시 해결 필수 (P0)**: Engineer의 E11-1(peakEquity 버그)과 E11-2(SignalFilter 바이패스 오류)는 실거래 수익성과 리스크 보호에 직접적 영향을 미치는 **심각한 버그**이다. 이 두 건은 이번 라운드에서 반드시 수정해야 한다.

**높은 가치**: E11-3(Trailing Stop 활성화)는 R10에서 투자한 구현 비용을 회수하는 작업이며, opt-in 방식으로 적용하면 리스크가 낮다. R11-FE-09(백테스트 비교)는 퀀트 워크플로우의 핵심 기능이므로 가능하면 이번 라운드에 포함할 것을 권장한다.

### 구현 순서 제안 (트레이딩 영향 기준)

| 순위 | ID | 사유 |
|------|-----|------|
| 1 | E11-1 | Drawdown 보호 무력화 — 자본 보전 직결 |
| 2 | E11-2 | 청산 시그널 차단 — 손실 확대 위험 |
| 3 | E11-3 | Dead code 활성화 — 수익 보호 메커니즘 완성 |
| 4 | E11-9 | 일일 리셋 누락 — 일일 손실 한도 무력화 가능 |
| 5 | E11-8 | WS 재구독 — 시세 피드 사일런트 장애 방지 |
| 6 | R11-FE-10 | 백테스트 입력 검증 — 비현실적 백테스트 방지 |
| 7 | R11-FE-09 | 백테스트 비교 — 전략 선택 워크플로우 개선 |
| 8~ | 나머지 | 코드 품질, 타입 안전성, 접근성 개선 |

### 반대 항목 없음

28건 전체에 대해 **반대(❌)하는 항목은 없다.** E11-3의 "모든 전략 기본 적용" 방식과 E11-6의 "180일 TTL"에 대해서만 조건부 동의를 달았으며, 대안을 제시했다.

### 리스크 경고

E11-1과 E11-2가 동시에 존재하는 현재 상태는, **Drawdown 보호가 세션 간 리셋되고 + 청산 시그널이 차단될 수 있는** 이중 취약점이다. 이 두 버그가 결합되면 "손실이 누적되는데 drawdown halt도 작동하지 않고, 전략의 청산 시그널도 차단되어 포지션이 방치되는" 시나리오가 가능하다. **P0 즉시 수정이 필수적이다.**
