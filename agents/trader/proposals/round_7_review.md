# Round 7 교차 리뷰 -- Trader

**작성자**: Senior Quant Trader
**작성일**: 2026-02-16
**리뷰 대상**: Engineer 제안서 (`agents/engineer/proposals/round_7.md`), UI 제안서 (`agents/ui/proposals/round_7.md`)

---

## Engineer 제안서 리뷰

### A-1. hysteresisMinCandles 상향 (3 -> 8)
- **판정**: ⚠️ 조건부 동의
- **사유**: 방향은 완전히 동의하나, **8은 여전히 부족하다**. 내 제안은 15이며 그 근거는 다음과 같다:
  - 1분봉 기준 8분은 BTC의 일시적 변동(뉴스 스파이크, 대량 주문, 워시 트레이딩)을 걸러내기에 불충분. 실제 암호화폐 시장에서 5-10분 지속되는 가짜 트렌드(fakeout)는 매우 흔하다.
  - 18개 전략의 최소 유효 매매 사이클 중앙값이 약 20분. 8분 hysteresis + 5분 쿨다운 = 13분 최소 간격인데, 이는 대부분의 전략이 단 하나의 매매 사이클도 완료하기에 빠듯하다.
  - 15분 hysteresis + 5분 쿨다운 = 20분 최소 간격으로, 18개 전략 중 약 80%가 최소 1 사이클을 완료할 수 있다.
  - **절충안**: 12를 제안한다. Engineer의 8과 내 15의 중간이며, 12분 + 5분 쿨다운 = 17분 최소 간격으로 대부분의 indicator-light 전략(cooldownMs 1-3분)이 여러 사이클을 돌릴 수 있다. Optimizer가 [5,15] 범위에서 최적값을 찾도록 하되, **기본값(default)은 12 이상**이어야 한다.

### A-2. 레짐 전환 쿨다운 (5분 / timestamp 기반)
- **판정**: ✅ 동의
- **사유**:
  - 5분(300,000ms) 쿨다운은 내 제안과 동일하며, 적절한 값이다.
  - timestamp 비교 방식은 타이머 누수 위험을 제거하고 테스트가 용이하여 매우 합리적인 엔지니어링 결정이다.
  - 쿨다운 중에도 pending 카운터를 계속 축적한다는 점이 중요한데, Engineer의 구현에서 이 부분이 명시되지 않았다. 쿨다운 중 `_pendingCount`가 `minCandles`를 초과한 채로 쿨다운이 끝나면 즉시 전환되어야 한다. 내 제안서의 의사코드에서는 이를 명시했으므로, Engineer가 구현 시 이 동작을 반영해야 한다.
  - RegimeOptimizer 연동 `[120000, 600000]` 범위도 합리적이나, 상한을 **900000 (15분)**까지 확장하는 것이 트레이딩 관점에서 더 안전하다. 급변하지 않는 시장(quiet/ranging)에서는 10분 이상의 쿨다운이 오히려 수익 보호에 유리하다.

### A-3. 히스테리시스 가중치 동적 조정 (전환 직후 보너스 2배 -> 점진 감소)
- **판정**: ⚠️ 조건부 동의
- **사유**:
  - 아이디어 자체는 트레이딩 관점에서 매우 매력적이다. 레짐 전환 직후 ping-pong을 강하게 억제하는 것은 수익 보호에 직결된다.
  - 그러나 이를 P2(개선)로 분류한 것에 동의하지 않는다. 내 제안(A-3)에서는 **정적 가중치 상향(0.10 -> 0.15)**을 제안했는데, Engineer의 동적 조정이 이를 대체한다면 P2가 아니라 **P1로 승격**해야 한다. 정적 상향보다 동적 보너스가 더 정교하지만, 둘 중 하나는 반드시 P0-P1에서 구현되어야 한다.
  - **보완 사항**: `effectiveBonus = w.hysteresis * (1 + (1 - decayFactor))` 공식에서, 전환 직후 2배(0.20)는 다른 개별 factor(multiSmaTrend 0.20, marketBreadth 0.20)와 동급이 된다. 이는 전환 직후에 "거의 전환 불가능"한 상태를 만드는데, 쿨다운 메커니즘(A-2)이 이미 이 역할을 하므로 **이중 잠금(double lock)**이 된다. 쿨다운이 있는 상황에서는 동적 보너스의 최대 배수를 1.5배로 낮추는 것이 적절하다.
  - **대안**: 내 제안대로 정적 0.15를 기본값으로 설정하되, 나머지 factor 가중치를 균등하게 -0.01씩 조정하는 것이 더 단순하고 예측 가능하다. 동적 보너스는 A+B 적용 후 실거래 데이터를 보고 필요성을 판단해도 늦지 않다.

### B-1. StrategyRouter 유예기간 핵심 구조 (setTimeout 기반)
- **판정**: ⚠️ 조건부 동의
- **사유**:
  - **유예기간 단일값(3분) 문제**: Engineer가 `this._graceMs = 180000` (3분)을 전체 전략에 동일하게 적용하는 설계인데, 이는 트레이딩 관점에서 부적절하다. 내 제안서에서 상세 분석한 대로, 전략 카테고리별로 유효 매매 사이클 시간이 크게 다르다:
    - CandlePattern: 5-15분 사이클 -> 3분 유예는 어느 정도 커버
    - SwingStructure: 30-120분 사이클 -> 3분 유예는 의미 없음
    - Breakout: 30-120분 사이클 -> 3분 유예는 의미 없음
  - **전략별 차별화 필수**: 내 제안은 `price-action: 10분, indicator-light: 5분, indicator-heavy: 15분`으로 차별화했다. Engineer의 설계에서 `setGracePeriod(ms)` 메서드가 전체 라우터에 하나의 값만 설정하는 구조인데, 이를 **전략별 override가 가능한 구조**로 변경해야 한다.
  - **구현 절충안**: `StrategyRouter._graceMs`를 기본값(fallback)으로 두되, `_startGrace()`에서 `strategy.getMetadata().gracePeriodMs || this._graceMs`를 사용하면 전략별 커스텀이 가능하다. 이는 내 제안서 B-1의 `meta.gracePeriodMs || this._getDefaultGracePeriod(strategy)` 패턴과 동일하다.
  - setTimeout 기반 vs 내 제안의 setInterval 폴링 기반: Engineer의 setTimeout이 더 정확하고 리소스 효율적이다. unref()도 적절하다. 이 부분은 Engineer의 설계가 우수하다.

### B-2. 유예 중 진입 차단 (방법 1: StrategyRouter -> BotService 통신)
- **판정**: ✅ 동의
- **사유**:
  - `getGracePeriodStrategies()` -> BotService에서 Set 체크하는 방식이 깔끔하다.
  - 기존 `_gracefulDisabledStrategies` 패턴과 동일한 흐름이므로 코드 일관성이 높다.
  - OPEN 차단 + CLOSE(SL/TP) 허용이 정확히 내 제안과 일치한다.
  - 방법 2(StrategyBase에 graceMode 플래그)를 대안으로만 두고 방법 1을 권장한 판단에 동의한다. 18개 전략 서브클래스 전부가 graceMode를 올바르게 처리할 것이라고 신뢰하기 어렵다.

### B-3. 유예 타이머 동시성 보호
- **판정**: ✅ 동의
- **사유**:
  - 레이스 컨디션 시나리오 분석이 철저하다. 특히 "유예 만료와 레짐 변경 동시" 케이스에서 `_gracePeriods.delete(name)`을 timer 콜백 최상단에서 실행하는 설계가 핵심적이다.
  - `if (!this._running) return;` 가드도 봇 stop 후 유령 콜백을 방지한다.
  - try-catch 래핑도 적절하다. 유예 만료 콜백에서 에러가 나면 다른 전략의 유예 처리까지 영향을 줄 수 있으므로.

### B-4. BotService.disableStrategy와 통합
- **판정**: ✅ 동의
- **사유**: 사용자가 수동으로 전략을 disable할 때 유예 타이머를 정리하는 것은 필수다. public 메서드 `cancelGracePeriod(name)` 추가가 깔끔하다.

### C-1~C-3. 관측성 강화
- **판정**: ✅ 동의
- **사유**:
  - C-1(전환 빈도 메트릭): `_transitionCountWindow`로 최근 1시간 전환 횟수를 추적하는 것은 실거래 모니터링에 필수적이다. 시간당 전환 횟수가 3회를 초과하면 파라미터 조정이 필요하다는 조기 경보가 된다.
  - C-2(유예 상태 노출): `getStatus()`에 `graceMs`, `gracePeriods[]` 추가는 프론트엔드와 디버깅 모두에 필요하다.
  - C-3(Socket.io 이벤트): `strategy:grace_started`, `strategy:grace_cancelled`, `strategy:grace_expired` 이벤트는 UI 에이전트의 P0-3 요구와 직결된다.

### D-1. 통합 파라미터 구조
- **판정**: ⚠️ 조건부 동의
- **사유**:
  - `routerGraceMs: 180000` (3분)을 StrategyRouter의 기본값으로 두는 것에 대해, 위 B-1에서 언급한 대로 이 값은 **최소 300000 (5분)**이어야 한다. 3분은 CandlePattern이나 Grid 같은 단기 전략에만 적합하고, 대부분의 전략에는 부족하다.
  - API 엔드포인트(`GET/PATCH /api/bot/regime-params`) 추가는 P2로 미뤄도 무방하나, 프론트엔드에서 향후 파라미터 튜닝 UI를 만들려면 결국 필요하므로 P1으로 분류한 것은 합리적이다.

### R7-7. 레짐 커버리지 분석
- **판정**: ✅ 동의 (분석 결과에 대해)
- **사유**: `quiet` 레짐에서 4개 전략만 활성화된다는 발견은 중요하다. `quiet -> volatile` 전환 시 대규모 전략 교체가 발생하므로, 이 전환 경로에서 유예기간이 특히 중요하다. 이 분석이 유예기간 차별화(내 제안의 B-1)를 더욱 정당화한다.

---

## UI 제안서 리뷰

### P0-1. 전략 상태 3-way 배지 (active / grace / inactive)
- **판정**: ✅ 동의
- **사유**:
  - 유예기간이 도입되면 UI에서 이 상태를 구분하지 않으면 트레이더는 "전략이 왜 시그널을 안 내는지" 혼란을 겪는다. 실제 매매에서 이런 혼란은 수동 개입(잘못된 수동 주문)으로 이어질 수 있다.
  - amber(호박색) 배지 + pulsing dot는 시각적 긴급성을 적절히 전달한다. 유예는 "곧 비활성화"를 의미하므로 경고 색상이 맞다.
  - `routerState`, `graceExpiresAt`, `graceReason` 필드 추가는 합리적이며, Engineer의 C-2 제안(getStatus 확장)과 자연스럽게 연동된다.

### P0-2. 레짐 pending/cooldown 상태 표시
- **판정**: ✅ 동의
- **사유**:
  - 트레이더에게 "레짐이 전환 중"이라는 정보는 매우 가치 있다. 현재는 레짐이 "확정"될 때만 UI가 변경되는데, 대기 중 상태를 보여주면 트레이더가 전략 교체를 사전에 인지하고 수동 개입 여부를 판단할 수 있다.
  - `pendingCount/hysteresisRequired` 진행바는 직관적이다. 예: "상승추세 전환 대기 (8/12 캔들)" 같은 표시.
  - 쿨다운 상태 표시도 필요하다. 쿨다운 중에 레짐 변경이 억제되고 있다는 것을 트레이더가 알아야 "시스템이 멈춘 건 아닌지" 불안해하지 않는다.

### P0-3. Socket 이벤트 + 상태 연동
- **판정**: ✅ 동의
- **사유**:
  - 폴링으로만 유예 상태를 갱신하면 3-30초 지연이 발생한다. 유예기간이 5-15분이면 이 지연은 허용 범위이지만, 유예 시작/취소 같은 이벤트는 즉시 전달되어야 트레이더의 상황 인식이 정확해진다.
  - `STRATEGY_GRACE_STARTED`, `STRATEGY_GRACE_EXPIRED`, `REGIME_PENDING`, `REGIME_COOLDOWN` 이벤트 정의가 명확하다.

### P1-1. 유예기간 카운트다운 타이머
- **판정**: ✅ 동의
- **사유**:
  - "유예 중 02:34 남음" 같은 실시간 카운트다운은 트레이더에게 행동 결정의 시간적 기준점을 제공한다. 유예가 끝나기 전에 수동으로 포지션을 청산할지, 유예 취소(레짐 복귀)를 기다릴지 판단할 수 있다.
  - 1초 간격 `setInterval`은 CPU 부담이 미미하며, 유예 중인 전략이 동시에 10개 이상일 가능성은 낮으므로 성능 우려 없다.

### P1-2. 레짐 전환 빈도 경고 인디케이터
- **판정**: ✅ 동의
- **사유**:
  - 트레이딩 관점에서 이 지표는 **시스템 건강 지표**다. 시간당 전환 횟수가 높다는 것은 hysteresis/쿨다운 파라미터가 현재 시장 조건에 부적합하다는 신호이며, 트레이더가 파라미터 조정을 고려해야 한다는 경보다.
  - 임계값 제안: `<=3 안정(녹), 4-6 빈번(호박), >=7 과다(빨강)` -- 합리적이다. A+B 적용 후 시간당 전환이 2회 이하로 안정화되는 것이 목표이므로, 3회가 경계선이다.

### P1-3. 전략 상태 전이 히스토리
- **판정**: ⚠️ 조건부 동의
- **사유**:
  - 디버깅 및 사후 분석에 유용하지만, **실시간 매매 중에 이 정보를 열람하는 트레이더는 드물다**. 대부분의 트레이더는 현재 상태(active/grace/inactive)와 잔여 시간만 보고 판단한다.
  - P1이 아니라 **P2로 강등**하고, 대신 P1-1(카운트다운)과 P1-2(전환 빈도 경고)에 리소스를 집중하는 것이 트레이딩 효율 관점에서 더 낫다.
  - 구현한다면, 로컬 배열 축적 방식은 브라우저 메모리 관리에 주의해야 한다. 24시간 연속 운영 시 이벤트가 수천 건 쌓일 수 있으므로 최대 100건 등의 제한이 필요하다.

### P2-1. 전략-레짐 호환성 매트릭스
- **판정**: ✅ 동의 (P2 분류에 동의)
- **사유**: 장기적으로 가치 있지만, R7의 핵심 문제(레짐 전환 안정화)와 직접적 관련이 적다. 백테스트 데이터가 충분히 축적된 후에 의미 있다.

### P2-2. 레짐 파라미터 설정 UI
- **판정**: ⚠️ 조건부 동의
- **사유**:
  - `hysteresisMinCandles` 슬라이더 범위를 **1~10**으로 제안했는데, 이는 내 권장값(15)과 Engineer의 기본값(8)을 모두 포함하지 못한다. **5~30**으로 범위를 넓혀야 한다.
  - 더 중요한 것은 **위험 경고**다. 이 파라미터를 잘못 설정하면 레짐이 전혀 전환되지 않거나(너무 높은 값) 매 분마다 전환되는(너무 낮은 값) 재앙이 발생한다. "고급 설정" 섹션에 배치하고, 변경 시 확인 다이얼로그를 표시해야 한다.

### P2-3. RegimeFlowMap grace 레인
- **판정**: ✅ 동의 (P2 분류에 동의)
- **사유**: 4-column 레이아웃(`레짐 -> 활성 / 유예 / 비활성`)은 직관적이지만, P0-1(3-way 배지)이 구현되면 FlowMap에서도 자연스럽게 구분이 되므로 우선순위는 낮다.

---

## 종합 의견

### 핵심 이견 사항

#### 1. hysteresisMinCandles: 8 vs 15 (가장 중요한 이견)

이 값은 시스템의 레짐 전환 빈도를 직접 결정하며, 모든 전략의 수익성에 영향을 미치는 핵심 파라미터다.

| 관점 | 8 (Engineer) | 15 (Trader) | 12 (절충안) |
|------|-------------|-------------|------------|
| 노이즈 필터링 | 1-5분 스파이크만 제거 | 10분 미만의 가짜 트렌드도 제거 | 5-8분 스파이크 제거 |
| 전략 사이클 확보 | indicator-light만 1 사이클 가능 | 대부분 전략 1 사이클 이상 | indicator-light 2-3 사이클, price-action 1 사이클 |
| 레짐 반응 지연 | 최소 13분 (8+5 쿨다운) | 최소 20분 (15+5 쿨다운) | 최소 17분 (12+5 쿨다운) |
| flash crash 대응 | emergencyStop으로 별도 처리 | 동일 | 동일 |

**권장**: 기본값 **12**, Optimizer 범위 **[8, 20]**. 이유:
- 8은 실전에서 너무 낮아 ping-pong이 잔존할 가능성이 높다
- 15는 보수적이어서 실제 레짐 변화 반영이 다소 늦을 수 있다
- 12는 양쪽의 장점을 취하되, Optimizer가 시장 조건에 따라 [8,20] 범위에서 자동 조정
- **단, 초기 운영 시에는 보수적으로 15를 사용하고, 실거래 데이터가 축적되면 Optimizer가 최적값을 찾도록** 하는 것이 가장 안전하다

#### 2. 유예기간 단일값 vs 전략별 차별화

Engineer의 설계는 `this._graceMs = 180000` (3분) 단일값이다. 내 제안은 카테고리별 차별화다. 이것은 **절대적으로 차별화가 필요하다**:

- Grid 전략(30초 cooldown, 짧은 사이클)에 15분 유예는 과도 -> 불필요한 리소스 소모
- SwingStructure(5분 cooldown, 30-120분 사이클)에 3분 유예는 무의미 -> SL/TP 관리 시간 부족
- **구현 비용이 매우 낮다**: `_startGrace()`에서 `strategy.getMetadata().gracePeriodMs || this._graceMs` 한 줄이면 충분

**권장**: Engineer의 setTimeout 기반 설계를 유지하되, `_startGrace()`에서 전략별 메타데이터의 `gracePeriodMs`를 우선 참조하는 로직을 추가. 기본 fallback은 5분(300000ms)으로.

#### 3. 히스테리시스 가중치 처리 방식

세 가지 옵션이 있다:
- (A) 내 제안: 정적 0.10 -> 0.15 상향
- (B) Engineer 제안: 동적 보너스 (전환 직후 2배 -> 점진 감소), P2 분류
- (C) 하이브리드: 정적 0.12로 소폭 상향 + 동적 보너스를 나중에 추가

**권장**: 우선 **(A) 정적 0.15 상향**을 P0에서 구현. 이유:
- 단순하고 예측 가능하며 테스트가 쉽다
- 쿨다운(A-2)이 이미 ping-pong을 물리적으로 차단하므로, 동적 보너스는 "이중 보험"에 가깝다
- 동적 보너스는 A+B 적용 후 실거래에서 ping-pong이 여전히 관찰되면 그때 추가해도 늦지 않다

### 권장 절충안 요약

| 항목 | Engineer 제안 | Trader 제안 | 최종 권장 |
|------|-------------|-------------|----------|
| hysteresisMinCandles 기본값 | 8 | 15 | **12** (초기 운영 시 15 권장) |
| Optimizer 범위 | [5, 15] | [10, 30] | **[8, 20]** |
| 전환 쿨다운 | 5분 | 5분 | **5분** (합의) |
| 쿨다운 Optimizer 범위 | [2분, 10분] | [2분, 15분] | **[2분, 15분]** |
| 히스테리시스 가중치 | 동적 (P2) | 정적 0.15 | **정적 0.15 (P0)**, 동적은 향후 |
| 유예기간 기본값 | 3분 (단일) | 카테고리별 차별화 | **카테고리별 차별화** (fallback 5분) |
| 유예 타이머 방식 | setTimeout (per-strategy) | setInterval 10초 폴링 | **setTimeout** (Engineer 방식 우수) |
| 유예 중 진입 차단 위치 | BotService (StrategyRouter 쿼리) | BotService (전략 직접 체크) | **BotService (StrategyRouter 쿼리)** |

### 구현 순서 권장

1. **A-1 + A-3**: hysteresisMinCandles 12로 상향 + 히스테리시스 가중치 0.15 (가장 빠르고 즉시 효과)
2. **A-2**: 전환 쿨다운 5분 (A-1과 결합하여 레짐 안정화 완성)
3. **A-4**: Optimizer 범위 [8,20] + 쿨다운 범위 [120000, 900000]
4. **B-1 + B-2**: 유예기간 핵심 구조 (전략별 차별화 포함) + 진입 차단
5. **B-3 + B-4**: 동시성 보호 + disableStrategy 통합
6. **C-1~C-3**: 관측성 (메트릭 + 상태 노출 + Socket 이벤트)
7. **FE P0-1~P0-3**: 3-way 배지 + pending/cooldown 표시 + Socket 연동
8. **FE P1-1, P1-2**: 카운트다운 타이머 + 전환 빈도 경고

### 추가 고려사항 (Engineer에게)

1. **쿨다운 중 pending 축적 동작 명확화**: 쿨다운 중에도 `_pendingCount`가 계속 증가하여, 쿨다운 만료 직후 `minCandles`를 이미 충족한 상태라면 즉시 전환되는 것이 올바른 동작이다. 이것을 코드에 명시적으로 구현해야 한다.
2. **emergencyStop과의 상호작용**: 쿨다운/유예기간과 무관하게 emergencyStop은 즉시 모든 전략을 비활성화하고 포지션을 청산해야 한다. 이 경로가 새 메커니즘에 의해 지연되지 않도록 보장해야 한다.
3. **백테스트 엔진과의 정합성**: 현재 `backtestEngine.js`는 레짐 전환 로직을 시뮬레이션하지 않는다. A+B가 적용되면 백테스트-실거래 간 괴리가 줄어들지만, 장기적으로 백테스트에서도 레짐 전환 + 유예기간을 시뮬레이션할 수 있어야 정확한 성과 예측이 가능하다. 이는 R8+ 과제로 기록해야 한다.
